@using Microsoft.AspNetCore.Identity
@using OptiShape.Models
@using Microsoft.EntityFrameworkCore
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject OptiShape.Data.ApplicationDbContext DbContext

@{
    ViewData["Title"] = "Dashboard";
    ViewData["FixedNavbar"] = true;

    var appUser = await UserManager.GetUserAsync(User);
    var isAdmin = User.IsInRole("Administrator");
    var isTrainer = User.IsInRole("Trener");

    Korisnik korisnik = null;
    bool showStudentApplication = false;
    bool showTrainerSelection = false;
    bool hasRecentPayment = false;
    DateTime lastMonth = DateTime.Now.AddMonths(-1);

    if (appUser != null && !isAdmin && !isTrainer)
    {
        korisnik = await DbContext.Korisnik.FirstOrDefaultAsync(k => k.Email == appUser.Email);
        showStudentApplication = korisnik != null && !korisnik.StudentskiStatus;
        showTrainerSelection = korisnik != null && korisnik.IdTrenera == null;

        // Check if user has made a payment in the last month
        if (korisnik != null)
        {
            hasRecentPayment = await DbContext.Placanje
                .AnyAsync(p => p.IdKorisnika == korisnik.IdKorisnika && p.DatumPlacanja >= lastMonth);
        }
    }
}

<div class="container">
    <div class="row">
        <div class="col-12 mb-4">
            <h1 class="mt-5">Dobrodošli na Dashboard!</h1>
            <a asp-controller="StatistikeNapretka" asp-action="Graf" class="btn btn-outline-primary">Prikaži graf</a>

            <p>Ovo je privatna stranica za prijavljene korisnike.</p>
        </div>

        @if (showStudentApplication)
        {
            <div class="col-12">
                <div class="card border-primary mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-mortarboard-fill me-2"></i>
                            Student ste?
                        </h5>
                        <p class="card-text">
                            Kao student imate pravo na posebne pogodnosti i popuste. Aplicirajte za studentski račun
                            kako biste ostvarili dodatne pogodnosti.
                        </p>
                        <a asp-controller="Home" asp-action="StudentApplication" class="btn btn-primary">
                            Apliciraj za studentski račun
                        </a>
                    </div>
                </div>
            </div>
        }

        @if (showTrainerSelection)
        {
            <div class="col-12">
                <div class="card border-success mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-person-check-fill me-2"></i>
                            Nemate trenera?
                        </h5>
                        <p class="card-text">
                            Odaberite svog personalnog trenera i započnite personalizirani program treninga i ishrane.
                        </p>
                        <a asp-controller="Home" asp-action="IzborTrenera" class="btn btn-success">
                            Izaberi trenera
                        </a>
                    </div>
                </div>
            </div>
        }

        @if (korisnik != null)
        {
            <div class="col-12">
                <div class="card border-@(korisnik.StudentskiStatus ? "primary" : "warning") mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-credit-card-fill me-2"></i>
                            Vaša mjesečna tarifa
                        </h5>
                        <p class="card-text">
                            Kao @(korisnik.StudentskiStatus ? "student" : "korisnik") OptiShape platforme, vaša mjesečna tarifa iznosi:
                        </p>
                        <h3 class="text-center mt-3 mb-3" style="color: @(korisnik.StudentskiStatus ? "#0d6efd" : "#fd7e14")">
                            <strong>@(korisnik.StudentskiStatus ? "7 KM" : "10 KM")</strong> mjesečno
                        </h3>
                        <p class="card-text text-center">
                            @if (korisnik.StudentskiStatus)
                            {
                                <span class="badge bg-primary">Studentski popust primijenjen!</span>
                            }
                            else
                            {
                                <small class="text-muted">Aplicirajte za studentski status i ostvarite popust na mjesečnu tarifu.</small>
                            }
                        </p>

                        <!-- Payment status for current month -->
                        <div class="alert @(hasRecentPayment ? "alert-success" : "alert-danger") text-center mt-3">
                            @if (hasRecentPayment)
                            {
                                <i class="bi bi-check-circle-fill me-2"></i>
                                <strong>Platili ste članarinu za ovaj mjesec.</strong>
                            }
                            else
                            {
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong>Niste platili članarinu za ovaj mjesec.</strong>
                            }
                        </div>

                        <!-- Payment button - show only if not paid recently -->
                        @if (!hasRecentPayment)
                        {
                            <div class="text-center mt-3">
                                <a asp-controller="Placanje" asp-action="CreateForUser" class="btn btn-warning">
                                    <i class="bi bi-cash-coin me-2"></i>
                                    Izvrši plaćanje članarine
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>